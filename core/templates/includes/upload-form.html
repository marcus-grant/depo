<!-- Upload Form -->
<form enctype="multipart/form-data" method="post" id="upload-form">
  {% csrf_token %}
  
  <!-- Main content input area -->
  <div class="box">
    <div class="field">
      <label for="content" class="label">Content</label>
      <div class="control">
        <textarea 
          id="content" 
          name="content" 
          class="textarea"
          placeholder="Paste text or linkâ€¦"
          rows="3"
          aria-describedby="content-help"
        ></textarea>
      </div>
    </div>
    
    <!-- Hidden file input for programmatic access -->
    <input 
      type="file" 
      id="file-input" 
      name="image" 
      accept=".jpg,.jpeg,.png"
      style="display: none;"
      aria-hidden="true"
    />
    
    <!-- Visible drop zone -->
    <div 
      id="drop-zone" 
      class="box has-text-centered is-clickable drop-zone"
      tabindex="0"
      role="button"
      aria-label="Click to select image files or drag and drop images here"
      aria-describedby="drop-zone-help"
    >
      <div class="content">
        <p class="is-size-5">
          <span class="icon is-large">
            <i class="fas fa-upload"></i>
          </span>
        </p>
        <p>Drop images here or click to select</p>
        <p class="is-size-7 has-text-grey">JPG, PNG up to 32 MiB</p>
      </div>
    </div>
    
    <!-- Image thumbnail container -->
    <div id="thumbnail-container" class="columns is-multiline" style="display: none;">
      <!-- Thumbnails will be dynamically inserted here -->
    </div>
    
    <!-- Help text -->
    <p id="content-help" class="help">
      Enter text content, paste a URL, or upload an image
    </p>
    <p id="drop-zone-help" class="help is-sr-only">
      Supported formats: JPEG, PNG. Maximum size: 32 MiB
    </p>
  </div>
  
  <!-- Hidden fields for form processing -->
  <input type="hidden" id="detected-type" name="detected_type" value="">
  
  <!-- Accessibility: Live region for announcements -->
  <div id="content-announcements" aria-live="polite" class="is-sr-only"></div>
  
  <!-- Submit button -->
  <div class="field">
    <div class="control">
      <button type="submit" class="button is-primary" id="submit-btn" disabled>
        Create Shortcode
      </button>
    </div>
  </div>
  
  <!-- No-JS fallback inputs (hidden by default, shown when JS disabled) -->
  <noscript>
    <div class="box">
      <h3 class="title is-5">Alternative Inputs</h3>
      <div class="field">
        <label for="fallback-url" class="label">URL:</label>
        <div class="control">
          <input type="url" id="fallback-url" name="fallback_url" class="input">
        </div>
      </div>
      <div class="field">
        <label for="fallback-text" class="label">Text:</label>
        <div class="control">
          <textarea id="fallback-text" name="fallback_text" class="textarea" rows="3"></textarea>
        </div>
      </div>
      <div class="field">
        <label for="fallback-file" class="label">Image File:</label>
        <div class="control">
          <input type="file" id="fallback-file" name="fallback_image" accept=".jpg,.jpeg,.png" class="input">
        </div>
      </div>
    </div>
  </noscript>
</form>

<!-- Custom styles for drag-and-drop behavior -->
<style>
.drop-zone {
  border: 2px dashed hsl(0, 0%, 86%);
  transition: all 0.2s ease;
}

.drop-zone:hover,
.drop-zone:focus {
  border-color: hsl(204, 86%, 53%);
  background-color: hsl(204, 100%, 97%);
}

.drop-zone.drag-over {
  border-color: hsl(204, 86%, 53%);
  background-color: hsl(204, 100%, 95%);
  border-style: solid;
}

.thumbnail {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 4px;
}
</style>

<!-- Upload Form JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');
  
  // Helper function for image type validation
  function isValidImageType(file) {
    return file.type === 'image/jpeg' || file.type === 'image/png';
  }
  
  // Helper function for file size validation
  function isValidFileSize(file) {
    const maxSize = {{ settings.MAX_UPLOAD_SIZE }};
    return file.size <= maxSize;
  }
  
  // Helper function to show toast messages
  function showToast(message) {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'notification is-danger';
    toast.textContent = message;
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    
    document.body.appendChild(toast);
    
    // Remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 5000);
  }
  
  // Helper function to render thumbnail and queue image
  function renderThumbnailAndQueue(file) {
    const thumbnailContainer = document.getElementById('thumbnail-container');
    if (!thumbnailContainer) return;
    
    // Create thumbnail column
    const column = document.createElement('div');
    column.className = 'column is-narrow';
    
    // Create thumbnail image
    const img = document.createElement('img');
    img.className = 'thumbnail';
    img.style.width = '100px';
    img.style.height = '100px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '4px';
    
    // Use URL.createObjectURL for immediate preview
    const objectURL = URL.createObjectURL(file);
    img.src = objectURL;
    
    // Add to DOM
    column.appendChild(img);
    thumbnailContainer.appendChild(column);
    
    // Show thumbnail container
    thumbnailContainer.style.display = 'block';
    
    // Store file for form submission (simple queue)
    if (!window.queuedFiles) {
      window.queuedFiles = [];
    }
    window.queuedFiles.push(file);
    
    // Clean up object URL when image loads
    img.onload = function() {
      URL.revokeObjectURL(objectURL);
    };
  }
  
  if (dropZone && fileInput) {
    // Add drag-over visual cue functionality
    dropZone.addEventListener('dragenter', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');
    });
    
    // Add file picker functionality
    dropZone.addEventListener('click', function(e) {
      e.preventDefault();
      fileInput.click();
    });
    
    dropZone.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });
    
    // Add clipboard paste functionality
    const contentTextarea = document.getElementById('content');
    if (contentTextarea) {
      contentTextarea.addEventListener('paste', function(e) {
        const clipboardData = e.clipboardData;
        if (clipboardData && clipboardData.files) {
          for (let i = 0; i < clipboardData.files.length; i++) {
            const file = clipboardData.files[i];
            if (isValidImageType(file)) {
              if (isValidFileSize(file)) {
                // Valid clipboard image detected - render thumbnail and queue
                renderThumbnailAndQueue(file);
                console.log('Valid image pasted:', file.name, file.size);
              } else {
                showToast('Only JPG or PNG under 32 MiB');
              }
            }
          }
        }
      });
    }
  }
});
</script>
